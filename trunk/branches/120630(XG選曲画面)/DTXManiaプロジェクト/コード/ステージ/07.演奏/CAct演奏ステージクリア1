using System;
using System.Collections.Generic;
using System.Text;
using SlimDX;
using SlimDX.Direct3D9;
using FDK;

namespace DTXMania
{
    internal class CAct演奏ステージクリア : CActivity
    {
        // コンストラクタ

        public CAct演奏ステージクリア()
        {
            this.ds背景動画 = null;
            this.tx背景動画 = null;
        }

        // CActivity 実装

        public override void On活性化(　Device D3D9Device　)
        {
            if (this.b活性化してる)
            {
                return;
            }
                this.ds背景動画 = CDTXMania.t失敗してもスキップ可能なDirectShowを生成する(CSkin.Path(@"Graphics\7_Stage Clear.mp4"), CDTXMania.App.hWnd, true);
                base.On活性化(D3D9Device);
            
        }
        public override void On非活性化()
        {
            this.ds背景動画 = null;
            base.On非活性化();
        }
        public override void OnManagedリソースの作成(Device D3D9Device)
        {
			if( this.b活性化してない )
				return;

            if (this.ds背景動画 != null)
            {
                this.tx背景動画 = CDTXMania.tテクスチャを生成する(this.ds背景動画.n幅px, this.ds背景動画.n高さpx);

                if (this.tx背景動画 != null)
                {
                    this.tx背景動画.vc拡大縮小倍率 = new Vector3(
                        ((float)1280 / (float)this.ds背景動画.n幅px),
                        ((float)720 / (float)this.ds背景動画.n高さpx),
                        1.0f);
                }
            }
            else
                this.tx背景動画 = null;

            base.OnManagedリソースの作成(D3D9Device);
        }
        public override void OnManagedリソースの解放()
        {
            if (!base.b活性化してない)
            {
                return;
            }
                CDTXMania.tテクスチャの解放(ref this.tx背景動画);
                base.OnManagedリソースの解放();
            
        }
        public override int On進行()
        {
            if (this.b活性化してない)
                return (int)CApp.E状態処理結果.ステージ継続;

            // 進行。

            #region [ 初めての進行処理。]
            //-----------------
            if (this.b初めての進行)
            {
                if (this.ds背景動画 != null)
                {
                    this.ds背景動画.bループ再生 = false;
                    this.ds背景動画.t再生開始();
                }

                this.b初めての進行 = false;
            }
            //-----------------
            #endregion

            if (this.ds背景動画 != null && !this.ds背景動画.b再生中)			// 再生完了したらステージ終了。
                return (int)CApp.E状態処理結果.OK;

            return (int)CApp.E状態処理結果.ステージ継続;
        }

        public override void On描画(Device D3D9Device)
        {
            if (!base.b活性化してない && ((this.ds背景動画 != null) && (this.tx背景動画 != null)))
            {
                this.ds背景動画.t現時点における最新のスナップイメージをTextureに転写する(this.tx背景動画);
                this.tx背景動画.t2D描画(D3D9Device, 0, 0);
            }
        }

 

 
#if n
        public override void On描画(Device D3D9Device)
        {
            if (base.b活性化してない)
            {
                //return 0;
            }
            #region [ 初めての進行処理。]
            //-----------------
            if (this.b初めての進行描画)
            {
                if (this.ds背景動画 != null)
                {
                    this.ds背景動画.bループ再生 = false;
                    this.ds背景動画.t再生開始();
                }

                this.b初めての進行描画 = false;
            }
            //-----------------
            #endregion

            #region [ 背景動画 ]
            //-----------------
            if (this.ds背景動画 != null &&
                this.tx背景動画 != null)
            {

                this.ds背景動画.t現時点における最新のスナップイメージをTextureに転写する(this.tx背景動画);
                this.tx背景動画.t2D描画(D3D9Device, 0, 0);
            }
            //-----------------
            #endregion
            if ((this.ct進行 == null) || this.ct進行.b停止中)
            {
                //return 0;
            }
            this.ct進行.t進行();

            if (!this.ct進行.b終了値に達した)
            {
                //return 0;
            }
            //return 1;
        }
#endif


        // その他

        #region [ private ]
        //-----------------
        private bool b効果音再生済み;
        private CCounter ct進行;
        private CSound sd効果音;
        protected volatile CDirectShow ds背景動画 = null;
        protected CTexture tx背景動画 = null;
        //-----------------
        #endregion
    }
}
